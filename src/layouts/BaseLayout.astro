---
import GlobalStyles from '../components/GlobalStyles.astro';
import Navbar from '../components/Navbar.astro';
import Footer from '../components/Footer.astro';
import ConsentBanner from '../components/ConsentBanner.astro';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  currentPage?: string;
}

const {
  title,
  description = "MMTUK promotes better public understanding of money, economics and government spending for a fairer, sustainable society.",
  ogImage = "/images/og-image.png",
  currentPage = ''
} = Astro.props;

const siteUrl = (Astro.site?.toString() || 'https://mmtuk.org').replace(/\/$/, '');
const canonicalUrl = `${siteUrl}${Astro.url.pathname}`;
const fullOgImage = ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage.startsWith('/') ? ogImage : '/' + ogImage}`;
const isProduction = import.meta.env.PUBLIC_ENV !== 'staging';
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{title} | MMTUK</title>
  <meta content={description} name="description">
  {!isProduction && <meta name="robots" content="noindex, nofollow">}
  <link rel="canonical" href={canonicalUrl}>
  <meta content={`${title} | MMTUK`} property="og:title">
  <meta content={description} property="og:description">
  <meta content={fullOgImage} property="og:image">
  <meta property="og:url" content={canonicalUrl}>
  <meta content={`${title} | MMTUK`} property="twitter:title">
  <meta content={description} property="twitter:description">
  <meta content={fullOgImage} property="twitter:image">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="MMTUK">
  <meta content="summary_large_image" name="twitter:card">
  <meta name="twitter:site" content="@MMTUK_PRG">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link href="/css/normalize.css" rel="stylesheet" type="text/css">
  <link href="/css/webflow.css" rel="stylesheet" type="text/css">
  <link href="/css/mmtuk.webflow.css" rel="stylesheet" type="text/css">
  <link href="/css/professional-overrides.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <script type="text/javascript">
    WebFont.load({
      google: {
        families: ["Montserrat:100,100italic,200,200italic,300,300italic,400,400italic,500,500italic,600,600italic,700,700italic,800,800italic,900,900italic"]
      }
    });
  </script>
  <script type="text/javascript">
    !function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);
  </script>
  <link href="/images/favicon.png" rel="shortcut icon" type="image/png">
  <link href="/images/webclip.png" rel="apple-touch-icon">
  <style>
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -o-font-smoothing: antialiased;
    }
  </style>
</head>
<body class="body">
  <div class="page-wrapper">
    <GlobalStyles />
    <Navbar currentPage={currentPage} />
    <main class="main-wrapper">
      <slot />
    </main>
    <Footer />
  </div>
  <ConsentBanner />
  <script>
    // Mobile navigation toggle (replaces webflow.js functionality)
    document.querySelectorAll('.w-nav-button').forEach(function(button) {
      button.addEventListener('click', function() {
        var nav = this.closest('.w-nav');
        var menu = nav ? nav.querySelector('.w-nav-menu') : null;
        if (menu) {
          this.classList.toggle('w--open');
          menu.classList.toggle('w--open');
        }
      });
    });
  </script>
  <script>
    (function () {
      var shareUrl = window.location.href;
      var encUrl = encodeURIComponent(shareUrl);
      var ogTitle = document.querySelector('meta[property="og:title"]');
      var shareTitle = encodeURIComponent(ogTitle ? ogTitle.content : document.title);
      var builders = {
        linkedin: function () { return "https://www.linkedin.com/sharing/share-offsite/?url=" + encUrl; },
        x: function () { return "https://x.com/intent/tweet?url=" + encUrl + "&text=" + shareTitle; },
        facebook: function () { return "https://www.facebook.com/sharer/sharer.php?u=" + encUrl; }
      };
      document.querySelectorAll('a[data-share]').forEach(function (a) {
        var net = a.getAttribute('data-share');
        if (builders[net]) {
          a.href = builders[net]();
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.setAttribute('aria-label', 'Share on ' + net.charAt(0).toUpperCase() + net.slice(1));
        }
      });
      function copyToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          return navigator.clipboard.writeText(text);
        }
        return new Promise(function(resolve, reject){
          try {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            var ok = document.execCommand('copy');
            document.body.removeChild(ta);
            ok ? resolve() : reject();
          } catch(e) { reject(e); }
        });
      }
      document.querySelectorAll('[data-copy="url"]').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          copyToClipboard(shareUrl)
            .then(function () {
              var original = btn.innerText;
              btn.innerText = 'Copied';
              btn.setAttribute('aria-live', 'polite');
              setTimeout(function(){ btn.innerText = original; }, 1500);
            })
            .catch(function () {
              window.open(shareUrl, '_blank');
            });
        });
        btn.setAttribute('aria-label', 'Copy page link');
        btn.href = '#';
      });
    })();
  </script>
  <style>
    .accordion1_bottom { transition: height 0.3s ease; overflow: hidden; }
    .accordion1_icon { transition: transform 0.3s ease; }
  </style>
  <script>
    // Accordion functionality
    document.querySelectorAll('.accordion1_top').forEach(function(trigger) {
      trigger.addEventListener('click', function() {
        var content = this.nextElementSibling;
        var icon = this.querySelector('.accordion1_icon');
        if (content && content.classList.contains('accordion1_bottom')) {
          var isOpen = content.style.height !== '0px' && content.style.height !== '';
          content.style.height = isOpen ? '0px' : content.scrollHeight + 'px';
          if (icon) icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
        }
      });
    });

    // Slider functionality - wrapped in setTimeout to run after Webflow's JS initializes
    setTimeout(function(){
      document.querySelectorAll('.w-slider').forEach(function(slider) {
        var slides = slider.querySelectorAll('.w-slide');
        var currentIndex = 0;
        var leftArrow = slider.querySelector('.w-slider-arrow-left');
        var rightArrow = slider.querySelector('.w-slider-arrow-right');

        // Clone arrows to remove Webflow's event handlers
        var newLeftArrow = leftArrow ? leftArrow.cloneNode(true) : null;
        var newRightArrow = rightArrow ? rightArrow.cloneNode(true) : null;
        if (newLeftArrow) leftArrow.parentNode.replaceChild(newLeftArrow, leftArrow);
        if (newRightArrow) rightArrow.parentNode.replaceChild(newRightArrow, rightArrow);

        var autoplay = slider.dataset.customAutoplay === 'true' || slider.dataset.autoplay === 'true';
        var delay = parseInt(slider.dataset.delay) || 4000;
        var intervalId;

        var navContainer = slider.querySelector('.w-slider-nav');
        if (navContainer) {
          navContainer.innerHTML = '';
          slides.forEach(function(slide, i) {
            var dot = document.createElement('div');
            dot.className = 'w-slider-dot' + (i === 0 ? ' w-active' : '');
            dot.addEventListener('click', function(e) {
              e.stopImmediatePropagation();
              goToSlide(i);
            });
            navContainer.appendChild(dot);
          });
        }
        var navDots = navContainer ? navContainer.querySelectorAll('.w-slider-dot') : [];

        function goToSlide(index) {
          if (index < 0) index = slides.length - 1;
          if (index >= slides.length) index = 0;
          currentIndex = index;
          slides[0].style.marginLeft = '-' + (currentIndex * 100) + '%';
          navDots.forEach(function(dot, i) {
            dot.classList.toggle('w-active', i === currentIndex);
          });
        }

        if (newLeftArrow) newLeftArrow.addEventListener('click', function() { goToSlide(currentIndex - 1); });
        if (newRightArrow) newRightArrow.addEventListener('click', function() { goToSlide(currentIndex + 1); });

        if (autoplay) {
          intervalId = setInterval(function() { goToSlide(currentIndex + 1); }, delay);
          slider.addEventListener('mouseenter', function() { clearInterval(intervalId); });
          slider.addEventListener('mouseleave', function() {
            intervalId = setInterval(function() { goToSlide(currentIndex + 1); }, delay);
          });
        }
      });
    }, 100);

    // Tabs functionality
    document.querySelectorAll('.w-tabs').forEach(function(tabContainer) {
      var tabLinks = tabContainer.querySelectorAll('.w-tab-link');
      var tabPanes = tabContainer.querySelectorAll('.w-tab-pane');

      tabLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          var targetTab = this.getAttribute('data-w-tab');

          tabLinks.forEach(function(l) { l.classList.remove('w--current'); });
          tabPanes.forEach(function(p) { p.classList.remove('w--tab-active'); });

          this.classList.add('w--current');
          tabPanes.forEach(function(pane) {
            if (pane.getAttribute('data-w-tab') === targetTab) {
              pane.classList.add('w--tab-active');
            }
          });
        });
      });
    });

    // Intersection Observer for section reveals
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

    document.querySelectorAll('.layout132_item, .team8_item, .blog1_item, .layout478_card, .testimonial-card')
      .forEach(el => {
        el.classList.add('reveal-on-scroll');
        observer.observe(el);
      });
  </script>
</body>
</html>
