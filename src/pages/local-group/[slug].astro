---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const localGroups = await getCollection('localGroups');
  return localGroups
    .filter(group => group.data.active)
    .map(group => ({
      params: { slug: group.data.slug },
      props: { group },
    }));
}

const { group } = Astro.props;
const { slug, name, title, tagline, headerImage, leaderName, leaderIntro, discordLink } = group.data;

const allLocalNews = await getCollection('localNews');
const localNews = allLocalNews
  .filter(item => item.data.localGroup === slug)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 4);

// Check which news items have body content (for article pages)
const newsWithBody = await Promise.all(
  localNews.map(async (item) => {
    const { Content } = await render(item);
    // Check if there's actual body content
    const hasBody = item.body && item.body.trim().length > 0;
    return { ...item, hasBody };
  })
);

const allLocalEvents = await getCollection('localEvents');
const localEvents = allLocalEvents
  .filter(item => item.data.localGroup === slug)
  .sort((a, b) => a.data.date.getTime() - b.data.date.getTime())
  .filter(event => event.data.date >= new Date())
  .slice(0, 6);
---

<BaseLayout title={title} description={tagline} currentPage="local-group">
<header class="section_header54 text-color-white">
        <div class="padding-global">
          <div class="container-large">
            <div class="padding-section-large">
              <div class="header54_component">
                <div class="max-width-large">
                  <div class="margin-bottom margin-small">
                    <h1 class="heading-style-h1">MMtuk | {name.toUpperCase()}</h1>
                  </div>
                  <p class="text-size-medium-2">{tagline}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="header54_background-image-wrapper">
          <div class="image-overlay-layer"></div><img loading="eager" src={headerImage} alt="" class="header54_background-image">
        </div>
      </header>
      <section id="Network" class="section_portfolio11 color-scheme-2">
        <div class="padding-global">
          <div class="container-large">
            <div class="padding-section-large">
              <div class="portfolio11_component">
                <div class="margin-bottom margin-xxlarge">
                  <div class="text-align-center">
                    <div class="max-width-large align-center">
                      <div class="margin-bottom margin-small">
                        <h2 class="heading-style-h2 left">Welcome</h2>
                      </div>
                      <p class="text-size-medium-11">
                        {leaderName && (
                          <Fragment>
                            <strong>MMTUK {name} Local Group</strong><br />
                            <em>From {leaderName}, {name} Local Group Leader</em><br /><br />
                          </Fragment>
                        )}
                        {leaderIntro ? leaderIntro.split('\n\n').map((para: string) => (
                          <Fragment>
                            {para}<br /><br />
                          </Fragment>
                        )) : (
                          <Fragment>
                            Welcome to the MMTUK {name} Local Group. We're building a community of people who want to understand Modern Monetary Theory and apply these insights to local issues.<br /><br />
                            Join us for discussions, learning, and community building.
                          </Fragment>
                        )}
                        Get involved at mmtuk.org/{slug}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      {newsWithBody.length > 0 && (
      <section id="LocalNews" class="section_faq4 color-scheme-1">
        <div class="padding-global">
          <div class="container-large">
            <div class="padding-section-large">
              <div class="faq4_component">
                <div class="margin-bottom margin-xxlarge">
                  <div class="text-align-center">
                    <div class="max-width-large align-center">
                      <div class="margin-bottom margin-small">
                        <h2 class="heading-style-h2 left">Local News</h2>
                      </div>
                      <p class="text-size-medium-12">Latest updates from your local group</p>
                    </div>
                  </div>
                </div>
                <div class="faq4_list">
                  {newsWithBody.map((item) => {
                    const articleLink = item.hasBody ? `/local-group/${slug}/${item.data.slug}` : null;
                    const externalLink = item.data.link;
                    const hasLink = articleLink || externalLink;
                    return (
                    <div class="accordion1_component">
                      <div data-w-id="local-news-accordion" class="accordion1_top">
                        <div class="accordion1_header-content" style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                          {item.data.image && (
                            <img src={item.data.image} alt="" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0;" />
                          )}
                          <div>
                            <div class="text-size-medium-19 text-weight-bold">{item.data.heading}</div>
                            <div class="text-size-small text-color-grey">{item.data.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</div>
                          </div>
                        </div>
                        <div class="accordion1_icon w-embed"><svg width="100%" height="100%" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.5303 20.8839C16.2374 21.1768 15.7626 21.1768 15.4697 20.8839L7.82318 13.2374C7.53029 12.9445 7.53029 12.4697 7.82318 12.1768L8.17674 11.8232C8.46963 11.5303 8.9445 11.5303 9.2374 11.8232L16 18.5858L22.7626 11.8232C23.0555 11.5303 23.5303 11.5303 23.8232 11.8232L24.1768 12.1768C24.4697 12.4697 24.4697 12.9445 24.1768 13.2374L16.5303 20.8839Z" fill="currentColor"></path>
                          </svg></div>
                      </div>
                      <div style="height:0px" class="accordion1_bottom">
                        <div class="margin-bottom margin-small">
                          <p>{item.data.text}</p>
                        </div>
                        {hasLink && (
                          <div class="button-group">
                            <a href={articleLink || externalLink} target={externalLink && !articleLink ? "_blank" : undefined} class="button-2 is-link is-icon">
                              <div>Read more</div>
                              <div class="icon-embed-xxsmall w-embed"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <path d="M6 3L11 8L6 13" stroke="CurrentColor" stroke-width="1.5"></path>
                                </svg></div>
                            </a>
                          </div>
                        )}
                      </div>
                    </div>
                    );
                  })}
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      )}
      {localEvents.length > 0 && (
      <section id="Events" class="section_event7 color-scheme-4">
        <div class="padding-global">
          <div class="divider-horizontal page_divider"></div>
          <div class="container-large">
            <div class="padding-section-large">
              <div class="event7_component">
                <div class="margin-bottom margin-xxlarge">
                  <div class="text-align-center">
                    <div class="max-width-large align-center">
                      <div class="margin-bottom margin-small">
                        <h2 class="heading-style-h2 left">Upcoming events</h2>
                      </div>
                      <p class="text-size-medium-12">Discover critical conversations shaping economic understanding</p>
                    </div>
                  </div>
                </div>
                <div class="event7_content">
                  <div class="event7_list-wrapper">
                    <div class="w-layout-grid event7_list">
                      {localEvents.map((event) => {
                        const eventDate = event.data.date;
                        const dayName = eventDate.toLocaleDateString('en-GB', { weekday: 'short' });
                        const dayNum = eventDate.getDate().toString().padStart(2, '0');
                        const monthYear = eventDate.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                        return (
                          <div class="event7_item">
                            <a href={event.data.link || "#"} target={event.data.link ? "_blank" : undefined} class="event7_item-link w-inline-block">
                              <div class="margin-bottom margin-small">
                                <div class="event7_image-wrapper">
                                  <div class="event7_date-wrapper">
                                    <div class="text-size-small-5">{dayName}</div>
                                    <div class="heading-style-h4">{dayNum}</div>
                                    <div class="text-size-small-5">{monthYear}</div>
                                  </div>
                                  <img loading="lazy" src={event.data.image || "/images/placeholder-image.svg"} alt="" class="event7_image" />
                                </div>
                              </div>
                              <div class="margin-bottom margin-xsmall">
                                <div class="event7_meta-wrapper">
                                  <div class="tag">
                                    <div>{event.data.tag}</div>
                                  </div>
                                </div>
                              </div>
                              <h3 class="heading-style-h5-6">{event.data.title}</h3>
                              <div class="margin-bottom margin-xxsmall">
                                <div>{event.data.location}</div>
                              </div>
                              <div class="text-size-regular">{event.data.description}</div>
                              <div class="margin-top margin-small">
                                <div class="button-group">
                                  <div class="button-2 is-link is-icon">
                                    <div>{event.data.link ? "Register now" : "Learn more"}</div>
                                    <div class="icon-embed-xxsmall w-embed"><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 3L11 8L6 13" stroke="CurrentColor" stroke-width="1.5"></path>
                                      </svg></div>
                                  </div>
                                </div>
                              </div>
                            </a>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      )}
      <section class="section_cta1">
        <div class="padding-global">
          <div class="divider-horizontal page_divider"></div>
          <div class="container-large">
            <div class="padding-section-large">
              <div class="cta1_component">
                <div class="w-layout-grid cta1_content">
                  <div class="cta1_content-left">
                    <div class="margin-bottom margin-small">
                      <h2 class="heading-style-h2 left">MMT hub</h2>
                    </div>
                    <p class="text-size-medium-13">Meet up with local MMTers from {name}<br><br>Join our moderated UK community on Discord for lively discussion, learning, events, and practical collaboration.<br><br>Then ask to join the MMT UK {name} Local Group.</p>
                    <div class="margin-top margin-medium">
                      <div class="button-group" style="margin-bottom: 1.5rem;">
                        <a href={discordLink || "https://discord.gg/S3UbxFe4FR"} target="_blank" class="button-2 w-button">Join Discord here</a>
                      </div>
                    </div>
                    <div class="accordion1_component">
                      <div data-w-id="e8e11ffe-fc4b-4109-4974-55da07695039" class="accordion1_top">
                        <div class="text-size-medium-19 text-weight-bold">If you have a Discord account already</div>
                        <div class="accordion1_icon w-embed"><svg width="100%" height="100%" viewbox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.5303 20.8839C16.2374 21.1768 15.7626 21.1768 15.4697 20.8839L7.82318 13.2374C7.53029 12.9445 7.53029 12.4697 7.82318 12.1768L8.17674 11.8232C8.46963 11.5303 8.9445 11.5303 9.2374 11.8232L16 18.5858L22.7626 11.8232C23.0555 11.5303 23.5303 11.5303 23.8232 11.8232L24.1768 12.1768C24.4697 12.4697 24.4697 12.9445 24.1768 13.2374L16.5303 20.8839Z" fill="currentColor"></path>
                          </svg></div>
                      </div>
                      <div style="height:0px" class="accordion1_bottom">
                        <div class="margin-bottom margin-small">
                          <p>Click the Discord link above, and once you're in, look for the {name} local group channel to connect with members in your area.</p>
                        </div>
                        <div class="button-group">
                          <a href={discordLink || "https://discord.gg/S3UbxFe4FR"} target="_blank" class="button-2 w-button">Join now</a>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="cta1_image-wrapper"><img loading="lazy" src="/images/MMTUK-Discord-2.avif" alt="" class="cta1_image"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
</BaseLayout>
