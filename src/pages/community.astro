---
import BaseLayout from '../layouts/BaseLayout.astro';
import EventBadge from '../components/EventBadge.astro';
import { getCollection } from 'astro:content';

const allLocalGroups = await getCollection('localGroups');
const localGroups = allLocalGroups
  .filter(group => group.data.active)
  .sort((a, b) => a.data.name.localeCompare(b.data.name));

const allEvents = await getCollection('localEvents');
const upcomingEvents = allEvents
  .filter(e => e.data.slug !== 'bill-mitchell-feb')
  .sort((a, b) => a.data.date.getTime() - b.data.date.getTime());

const localGroupMap = Object.fromEntries(
  allLocalGroups.map(g => [g.data.slug, g.data.title])
);

function formatEventDate(date: Date) {
  const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return {
    day: days[date.getDay()],
    date: date.getDate().toString(),
    monthYear: `${months[date.getMonth()]} ${date.getFullYear()}`,
  };
}
---

<BaseLayout title="Community" description="Connect with the MMTUK community. Find local groups across the UK, join our Discord server, attend events, and engage with others interested in Modern Monetary Theory." currentPage="community">
<header class="section_header54 text-color-white">
        <div class="padding-global">
          <div class="container-large">
            <div class="padding-section-large">
              <div class="header54_component">
                <div class="max-width-large">
                  <div class="margin-bottom margin-small">
                    <h1 class="heading-style-h1">Community</h1>
                  </div>
                  <p class="text-size-medium-2">Meet, learn and organise with people building a better UK economy.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="header54_background-image-wrapper">
          <div class="image-overlay-layer"></div><img sizes="(max-width: 1920px) 100vw, 1920px" srcset="/images/Local-events-p-500.avif 500w, images/Local-events-p-800.avif 800w, images/Local-events-p-1080.avif 1080w, images/Local-events.avif 1920w" alt="" src="/images/Local-events.avif" loading="eager" class="header54_background-image">
        </div>
      </header>
      <div id="Network" class="padding-global">
        <div class="container-large">
          <div class="divider-horizontal page_divider"></div>
        </div>
      </div>
      <section class="section_portfolio11 color-scheme-2">
        <div class="padding-global">
          <div class="container-large">
            <div class="padding-section-large">
              <div class="portfolio11_component">
                <div class="margin-bottom margin-xxlarge">
                  <div class="text-align-center">
                    <div class="max-width-large align-center">
                      <div class="margin-bottom margin-small">
                        <h2 class="heading-style-h2 left">Local Groups</h2>
                      </div>
                      <p class="text-size-medium-11">Connect with MMT supporters in your area to share knowledge, discuss regional issues and coordinate local campaigns together.</p>
                    </div>
                  </div>
                </div>
                <div class="portfolio11_content">
                  <div class="portfolio11_list-wrapper">
                    <div class="w-layout-grid portfolio11_list">
                      {localGroups.map((group) => (
                        <div class="portfolio11_item">
                          <a href={`/local-group/${group.data.slug}`} class="portfolio11_item-link w-inline-block">
                            <div class="margin-bottom margin-small">
                              <div class="portfolio11_image-wrapper"><img sizes="(max-width: 640px) 100vw, 640px" src={group.data.headerImage} alt={group.data.name} loading="lazy" class="portfolio11_image"></div>
                            </div>
                            <div class="margin-bottom margin-xxsmall">
                              <h3 class="heading-style-h5-6">{group.data.title}</h3>
                            </div>
                            <div class="text-size-regular">{group.data.tagline}</div>
                            <div class="margin-top margin-small">
                              <div class="button-group">
                                <div class="button-2 is-link is-icon">
                                  <div>Get involved</div>
                                  <div class="icon-embed-xxsmall w-embed"><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                      <path d="M6 3L11 8L6 13" stroke="CurrentColor" stroke-width="1.5"></path>
                                    </svg></div>
                                </div>
                              </div>
                            </div>
                          </a>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <div id="Events" class="padding-global">
        <div class="container-large">
          <div class="divider-horizontal page_divider"></div>
        </div>
      </div>
      <section class="section_event7 color-scheme-4">
        <div class="padding-global">
          <div class="container-large">
            <div class="padding-section-large">
              <div class="event7_component">
                <div class="margin-bottom margin-xxlarge">
                  <div class="text-align-center">
                    <div class="max-width-large align-center">
                      <div class="margin-bottom margin-small">
                        <h2 class="heading-style-h2 left">Upcoming events</h2>
                      </div>
                      <p class="text-size-medium-12">Discover critical conversations shaping economic understanding</p>
                    </div>
                  </div>
                </div>
                <div class="event7_content">
                  <div class="event7_list-wrapper">
                    <div class="w-layout-grid event7_list" style="justify-content: center;">
                      {upcomingEvents.map((event) => {
                        const d = formatEventDate(event.data.date);
                        const groupName = localGroupMap[event.data.localGroup] || event.data.localGroup;
                        return (
                          <div class="event7_item">
                            <a href={event.data.link || `#`} target={event.data.link && !event.data.link.startsWith('/') ? "_blank" : undefined} rel={event.data.link && !event.data.link.startsWith('/') ? "noopener noreferrer" : undefined} class="event7_item-link w-inline-block">
                              <div class="margin-bottom margin-small">
                                <div class="event7_image-wrapper">
                                  <div class="event7_date-wrapper">
                                    <div class="text-size-small-5">{d.day}</div>
                                    <div class="heading-style-h4">{d.date}</div>
                                    <div class="text-size-small-5">{d.monthYear}</div>
                                  </div>
                                  <img loading="lazy" src={event.data.image || '/images/placeholder-image.svg'} alt={event.data.title} class="event7_image">
                                </div>
                              </div>
                              <div class="margin-bottom margin-xsmall">
                                <div class="event7_meta-wrapper">
                                  <div class="tag">
                                    <div>{event.data.tag}</div>
                                  </div>
                                  {!event.data.partnerEvent && (
                                    <div class="tag" style="background-color: var(--_mmt-uk-theme---sercondary); color: var(--_mmt-uk-theme---text);">
                                      <div>{groupName}</div>
                                    </div>
                                  )}
                                  {event.data.partnerEvent && <EventBadge label="Partner Event" variant="partner" />}
                                </div>
                              </div>
                              <h3 class="heading-style-h5-6">{event.data.title}</h3>
                              <div class="margin-bottom margin-xxsmall">
                                <div>{event.data.location}</div>
                              </div>
                              <div class="text-size-regular">{event.data.description}</div>
                              <div class="margin-top margin-small">
                                <div class="button-group">
                                  <div class="button-2 is-link is-icon">
                                    <div>Learn more</div>
                                    <div class="icon-embed-xxsmall w-embed"><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 3L11 8L6 13" stroke="CurrentColor" stroke-width="1.5"></path>
                                      </svg></div>
                                  </div>
                                </div>
                              </div>
                            </a>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <div id="discord" class="padding-global">
        <div class="container-large">
          <div class="divider-horizontal page_divider"></div>
        </div>
      </div>
      <section class="section_cta1">
        <div class="padding-global">
          <div class="container-large">
            <div class="padding-section-large">
              <div class="cta1_component">
                <div class="w-layout-grid cta1_content">
                  <div class="cta1_content-left">
                    <div class="margin-bottom margin-small">
                      <h2 class="heading-style-h2 left">MMTUK Discord Server</h2>
                    </div>
                    <p class="text-size-medium-13">Join our moderated UK community on Discord for lively discussion, learning, events, and practical collaboration.<br><br>Connect with MMT advocates across the UK and find your local group.</p>
                    <div class="margin-top margin-medium">
                      <div class="button-group" style="margin-bottom: 1.5rem;">
                        <a href="https://discord.gg/S3UbxFe4FR" target="_blank" class="button-2 w-button">Join Discord here</a>
                      </div>
                    </div>
                  </div>
                  <div class="cta1_image-wrapper" style="align-self: start;"><img loading="lazy" src="/images/MMTUK-Discord-2.avif" alt="" class="cta1_image"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
</BaseLayout>
